<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>星野娜娜♪歌单（按字数分类）</title>

  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <link rel="icon" href="favicon.png" type="image/png">

  <style>
    /* 美化下拉选单 */
    .note-select {
      padding: 4px 6px;
      font-size: 0.78em;
      background: rgba(255,255,255,0.12);
      color: #fff;
      border: none;
      border-radius: 6px;
      min-width: 62px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    .note-select option { background: #1a1a2e; color: #fff; }
    .note-select.good   { background: rgba(80, 200, 120, 0.45); }
    .note-select.normal { background: rgba(255, 193, 7, 0.4); }
    .note-select.bad    { background: rgba(255, 99, 132, 0.4); }
  </style>
</head>
<body>
  <div class="snow" id="snow"></div>
  <div id="nana-pet"><img src="Nana.png" alt="星野娜娜桌宠"></div>

  <div class="container">
    <header>
      <h1>星野娜娜的歌单</h1>
      <p class="subtitle">加载中…</p>
    </header>

    <div class="search">
      <input type="text" id="searchInput" placeholder="搜索歌名或歌手…">
    </div>

    <div id="categories"></div>

    <div class="footer">
      © 2025 星野娜娜 私人歌单<br>
      想听哪首点一下「复制」→直播间直接粘贴发送就行哦～
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'nanasing_progress_2025';
    let progress = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
    let allSongs = [];

    function getTodayDate() {
      const d = new Date();
      return [d.getFullYear(), String(d.getMonth() + 1).padStart(2, '0'), String(d.getDate()).padStart(2, '0')].join('-');
    }

    // 统一保存函数，防止重复写
    function saveProgress() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(progress));
    }

    fetch('songs.json')
      .then(r => { if (!r.ok) throw new Error('找不到 songs.json'); return r.json(); })
      .then(songs => {
        allSongs = songs;
        renderAll();
        const sub = document.querySelector('.subtitle');
        sub.textContent = '共0首 · 按歌名字数分类 · 搜歌名/歌手 · 点复制直接发直播间';
        sub.dataset.original = sub.textContent;
        updateCounter();
      })
      .catch(err => {
        document.body.innerHTML += `<h2 style="color:#ff6b6b;text-align:center;margin:60px;">載入失敗：${err.message}</h2>`;
      });

    function groupByLength(songs) {
      const g = {};
      songs.forEach(s => { const l = s.title.length; g[l] = g[l] || []; g[l].push(s); });
      return g;
    }

    function renderAll() {
      const container = document.getElementById('categories');
      container.innerHTML = '';
      const groups = groupByLength(allSongs);
      const maxLen = Math.max(...Object.keys(groups).map(Number), 1);

      for (let len = 1; len <= maxLen; len++) {
        if (!groups[len]) continue;

        const cat = document.createElement('div');
        cat.className = 'category';

        const header = document.createElement('div');
        header.className = 'cat-header';
        header.innerHTML = `<span>${len}字歌</span><span class="cat-count">(${groups[len].length})</span>`;

        const body = document.createElement('div');
        body.className = 'cat-body';

        groups[len].forEach(song => {
          const item = document.createElement('div');
          item.className = 'song-item';
          item.dataset.title = song.title;

          const data = progress[song.title];
          if (data?.date) item.style.background = 'rgba(100,255,180,0.15)';

          item.innerHTML = `
            <div class="song-info" style="flex:1; min-width:0; padding-right:12px;">
              <div class="title" style="font-size:1.05em; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${song.title}</div>
              ${song.artist ? `<div class="artist" style="opacity:0.88; margin-top:2px; font-size:0.92em;">${song.artist}</div>` : ''}
            </div>
            <button class="copy">复制</button>
          `;

          // 控制区
          const controlBar = document.createElement('div');
          controlBar.style.cssText = 'display:flex; align-items:center; gap:50px; flex-shrink:0;';

          // 勾选框
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.style.transform = 'scale(1.4)';
          checkbox.checked = !!(data?.date);

          // 日期
          const dateLabel = document.createElement('small');
          dateLabel.style.cssText = 'font-size:0.82em; opacity:0.9; min-width:50px; text-align:center; cursor:pointer;';
          dateLabel.title = '點這裡改日期';
          if (data?.date) dateLabel.textContent = data.date.slice(5,10).replace('-','/');

          // 长按打开日历
          let longPressTimer, isLongPress = false;
          const LONG_PRESS_DURATION = 500;

          const openCalendar = e => {
            e.stopPropagation();
            if (checkbox.dataset.processing) return;
            checkbox.dataset.processing = 'true';
            isLongPress = true;

            const picker = flatpickr(document.createElement('div'), {
              defaultDate: data?.date || new Date(),
              maxDate: new Date(),
              locale: "zh",
              disableMobile: true,
              onChange: (selectedDates, dateStr) => {
                progress[song.title] = progress[song.title] || {};
                progress[song.title].date = dateStr;
                dateLabel.textContent = dateStr.slice(5,10).replace('-','/');
                checkbox.checked = true;
                item.style.background = 'rgba(100,255,180,0.15)';
                saveProgress();
                updateCounter();
              },
              onClose: () => { delete checkbox.dataset.processing; }
            });

            setTimeout(() => { picker.open();
              setTimeout(() => {
                const rect = checkbox.getBoundingClientRect();
                const cal = picker.calendarContainer;
                cal.style.position = 'absolute';
                cal.style.top = `${rect.bottom + window.scrollY + 8}px`;
                cal.style.left = `${Math.min(rect.left + window.scrollX - 80, window.innerWidth - 320)}px`;
                cal.style.zIndex = '9999';
              }, 50);
            }, 100);
          };

          checkbox.addEventListener('change', () => {
            if (isLongPress) return;
            if (checkbox.checked) {
              const today = getTodayDate();
              progress[song.title] = progress[song.title] || {};
              progress[song.title].date = today;
              dateLabel.textContent = today.slice(5,10).replace('-','/');
              item.style.background = 'rgba(100,255,180,0.15)';
            } else {
              if (progress[song.title]) {
                delete progress[song.title].date;
                if (!progress[song.title].note) delete progress[song.title];
              }
              dateLabel.textContent = '';
              item.style.background = '';
            }
            saveProgress();
            updateCounter();
          });

          checkbox.addEventListener('mousedown', e => {
            if (e.button !== 0) return;
            longPressTimer = setTimeout(() => { isLongPress = true; checkbox.checked = true; openCalendar(e); }, LONG_PRESS_DURATION);
          });
          ['mouseup','mouseleave'].forEach(ev => checkbox.addEventListener(ev, () => clearTimeout(longPressTimer)));
          dateLabel.onclick = e => { e.stopPropagation(); checkbox.checked = true; openCalendar(e); };

          // 评价下拉选单
          const noteSelect = document.createElement('select');
          noteSelect.className = 'note-select';
          noteSelect.innerHTML = `<option value="">—</option><option value="好听">好听</option><option value="普通">普通</option><option value="不熟">不熟</option>`;
          if (data?.note) {
            noteSelect.value = data.note;
            noteSelect.classList.add(data.note === '好听' ? 'good' : data.note === '普通' ? 'normal' : 'bad');
          }
          noteSelect.addEventListener('change', () => {
            const val = noteSelect.value;
            progress[song.title] = progress[song.title] || {};
            if (val) {
              progress[song.title].note = val;
            } else {
              delete progress[song.title].note;
              if (!progress[song.title].date) delete progress[song.title];
            }
            noteSelect.classList.remove('good','normal','bad');
            if (val === '好听') noteSelect.classList.add('good');
            if (val === '普通') noteSelect.classList.add('normal');
            if (val === '不熟') noteSelect.classList.add('bad');
            saveProgress();
          });

          controlBar.append(checkbox, dateLabel, noteSelect);
          item.appendChild(controlBar);

          // 复制按钮
          item.querySelector('.copy').onclick = () => {
            const txt = song.artist ? `${song.title} - ${song.artist}` : song.title;
            navigator.clipboard.writeText(txt);
            const btn = item.querySelector('.copy');
            btn.textContent = '已复制';
            setTimeout(() => btn.textContent = '复制', 1500);
          };

          body.appendChild(item);
        });

        header.onclick = () => { header.classList.toggle('open'); body.classList.toggle('open'); };
        cat.append(header, body);
        container.appendChild(cat);
      }
    }

    function updateCounter() {
      const total = allSongs.length;
      const done = Object.keys(progress).filter(k => progress[k]?.date).length;
      const pct = total === 0 ? 0 : Math.round((done / total) * 100);
      const sub = document.querySelector('.subtitle');
      if (!sub.dataset.original) sub.dataset.original = '共0首 · 按歌名字数分类 · 搜歌名/歌手 · 点复制直接发直播间';
      sub.innerText = sub.dataset.original.replace('共0首', `共${total}首`) +
                      ` | 已點：${done}/${total}（${pct}%）` +
                      (done === total && total > 0 ? ' 全部點完啦！' : ' 加油～');
    }

    // 搜索
    document.getElementById('searchInput').oninput = function() {
      const kw = this.value.trim().toLowerCase();
      document.querySelectorAll('.song-item').forEach(item => {
        const t = item.dataset.title.toLowerCase();
        const a = (item.querySelector('.artist')?.innerText || '').toLowerCase();
        if (kw === '' || t.includes(kw) || a.includes(kw)) {
          item.style.display = '';
          item.closest('.cat-body').classList.add('open');
          item.closest('.cat-body').previousElementSibling.classList.add('open');
        } else {
          item.style.display = 'none';
        }
      });
    };

    // 长按标题清空
    const h1 = document.querySelector('h1');
    let timer;
    h1.onmousedown = e => { if (e.button === 0) timer = setTimeout(() => confirm('要清空所有點歌進度嗎？（不可恢復）') && (localStorage.removeItem(STORAGE_KEY), location.reload()), 3000); };
    h1.onmouseup = h1.onmouseleave = () => clearTimeout(timer);

    // 飘雪
    const snow = document.getElementById('snow');
    setInterval(() => {
      const s = document.createElement('div');
      s.innerText = ['❅', '❆', '✻'][Math.random()*3|0];
      s.style.cssText = `position:absolute;left:${Math.random()*100}vw;top:-20px;font-size:${Math.random()*16+10}px;opacity:${Math.random()*0.6+0.4};animation:fall ${Math.random()*10+10}s linear forwards;`;
      snow.appendChild(s);
      setTimeout(() => s.remove(), 20000);
    }, 350);
    document.head.appendChild(Object.assign(document.createElement('style'), {innerHTML: `@keyframes fall{to{transform:translateY(100vh) rotate(360deg)}}`}));
  </script>
</body>
</html>
