<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>星野娜娜♪歌单（按字数分类）</title>

  <!-- 外部样式 -->
  <link rel="stylesheet" href="styles.css">
  <!-- 美美的日期选择器（CDN）-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <!-- Favicon -->
  <link rel="icon" href="favicon.png" type="image/png">

  <style>
    /* 笔记下拉选单变小 */
    .note-select {
      padding: 3px 6px;
      font-size: 0.75em;
      background: rgba(255,255,255,0.12);
      color: #fff;
      border-radius: 6px;
      border: none;
    }
    .song-info .title { font-size: 1.1em; font-weight: 600; }
    .song-info .artist { font-size: 0.9em; opacity: 0.85; }
  </style>
</head>
<body>
  <!-- 飘雪特效 -->
  <div class="snow" id="snow"></div>

  <!-- 桌宠娜娜 -->
  <div id="nana-pet"><img src="Nana.png" alt="星野娜娜桌宠"></div>

  <div class="container">
    <header>
      <h1>星野娜娜的歌单</h1>
      <p class="subtitle">加载中…</p>
    </header>

    <div class="search">
      <input type="text" id="searchInput" placeholder="搜索歌名或歌手…">
    </div>

    <div id="categories"></div>

    <div class="footer">
      © 2025 星野娜娜 私人歌单<br>
      想听哪首点一下「复制」→直播间直接粘贴发送就行哦～
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'nanasing_progress_2025';
    let progress = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
    let allSongs = [];

    function getTodayDate() {
      const d = new Date();
      return [
        d.getFullYear(),
        String(d.getMonth() + 1).padStart(2, '0'),
        String(d.getDate()).padStart(2, '0')
      ].join('-');
    }

    fetch('songs.json')
      .then(r => { if (!r.ok) throw new Error('找不到 songs.json'); return r.json(); })
      .then(songs => {
        allSongs = songs;
        renderAll();
        const sub = document.querySelector('.subtitle');
        sub.textContent = '共0首 · 按歌名字数分类 · 搜歌名/歌手 · 点复制直接发直播间';
        sub.dataset.original = sub.textContent;
        updateCounter();
      })
      .catch(err => {
        document.body.innerHTML += `<h2 style="color:#ff6b6b;text-align:center;margin:60px;">載入失敗：${err.message}</h2>`;
      });

    function groupByLength(songs) {
      const g = {};
      songs.forEach(song => {
        const l = song.title.length;
        g[l] = g[l] || [];
        g[l].push(song);
      });
      return g;
    }

    function renderAll() {
      const container = document.getElementById('categories');
      container.innerHTML = '';
      const groups = groupByLength(allSongs);
      const maxLen = Math.max(...Object.keys(groups).map(Number), 1);

      for (let len = 1; len <= maxLen; len++) {
        if (!groups[len]) continue;

        const cat = document.createElement('div');
        cat.className = 'category';

        const header = document.createElement('div');
        header.className = 'cat-header';
        header.innerHTML = `<span>${len}字歌</span><span class="cat-count">(${groups[len].length})</span>`;

        const body = document.createElement('div');
        body.className = 'cat-body';

        groups[len].forEach(song => {
          const item = document.createElement('div');
          item.className = 'song-item';
          item.dataset.title = song.title;

          const data = progress[song.title];
          if (data?.date) item.style.background = 'rgba(100,255,180,0.15)';

          item.innerHTML = `
            <div class="song-info">
              <div class="title">${song.title}</div>
              ${song.artist ? `<div class="artist">${song.artist}</div>` : ''}
            </div>
            <button class="copy">复制</button>
          `;

          const controlBar = document.createElement('div');
          controlBar.style.cssText = 'display:flex;align-items:center;gap:10px;min-width:180px;justify-content:flex-end;flex-shrink:0;';

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.style.transform = 'scale(1.3)';
          checkbox.checked = !!(data?.date);

          const dateLabel = document.createElement('small');
          dateLabel.style.cssText = 'font-size:0.82em;opacity:0.9;min-width:50px;text-align:center;cursor:pointer;';
          if (data?.date) dateLabel.textContent = data.date.slice(5,10).replace('-','/');

          checkbox.addEventListener('change', () => {
            if (checkbox.checked) {
              const today = getTodayDate();
              progress[song.title] = progress[song.title] || {};
              progress[song.title].date = today;
              dateLabel.textContent = today.slice(5,10).replace('-','/');
              item.style.background = 'rgba(100,255,180,0.15)';
            } else {
              if (progress[song.title]) {
                delete progress[song.title].date;
                if (!progress[song.title].note) delete progress[song.title];
              }
              dateLabel.textContent = '';
              item.style.background = '';
            }
            localStorage.setItem(STORAGE_KEY, JSON.stringify(progress));
            updateCounter();
          });

          const note = document.createElement('select');
          note.className = 'note-select';

          ['','好听','普通','不熟'].forEach(opt => {
            const o = document.createElement('option');
            o.value = opt;
            o.textContent = opt || '评价';
            note.appendChild(o);
          });

          if (data?.note) note.value = data.note;

          note.addEventListener('change', () => {
            progress[song.title] = progress[song.title] || {};
            progress[song.title].note = note.value || '';
            if (!progress[song.title].note && !progress[song.title].date) delete progress[song.title];
            localStorage.setItem(STORAGE_KEY, JSON.stringify(progress));
          });

          controlBar.appendChild(checkbox);
          controlBar.appendChild(dateLabel);
          controlBar.appendChild(note);
          item.appendChild(controlBar);

          item.querySelector('.copy').onclick = () => {
            const txt = song.artist ? `${song.title} - ${song.artist}` : song.title;
            navigator.clipboard.writeText(txt);
            item.querySelector('.copy').textContent = '✓';
            setTimeout(() => item.querySelector('.copy').textContent = '复制', 1500);
          };

          body.appendChild(item);
        });

        header.onclick = () => {
          header.classList.toggle('open');
          body.classList.toggle('open');
        };

        cat.appendChild(header);
        cat.appendChild(body);
        container.appendChild(cat);
      }
    }

    function updateCounter() {
      const total = allSongs.length;
      const done = Object.keys(progress).filter(k => progress[k]?.date).length;
      const pct = total === 0 ? 0 : Math.round((done / total) * 100);
      const sub = document.querySelector('.subtitle');
      if (!sub.dataset.original) sub.dataset.original = '共0首 · 按歌名字数分类 · 搜歌名/
