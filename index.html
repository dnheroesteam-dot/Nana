<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>星野娜娜♪歌单（按字数分类）</title>
<link rel="stylesheet" href="styles.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<link rel="icon" href="favicon.png" type="image/png">

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAit4vQ_Ipnb6GszQiljMSwCNxdYIgEMYo",
    authDomain: "nanasong-3f39a.firebaseapp.com",
    projectId: "nanasong-3f39a",
    storageBucket: "nanasong-3f39a.appspot.com",
    messagingSenderId: "892672210670",
    appId: "1:892672210670:web:b0bd76cc8e2f7e1052a5ff",
    measurementId: "G-E7Z50XM521"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.firebaseDB = db; // 全局引用
</script>

</head>
<body>
<div class="snow" id="snow"></div>
<div id="nana-pet"><img src="Nana.png" alt="星野娜娜桌宠"></div>

<div class="container">
  <header>
    <h1>星野娜娜的歌单</h1>
    <p class="subtitle">加载中…</p>
  </header>

  <div class="search">
    <input type="text" id="searchInput" placeholder="搜索歌名或歌手…">
  </div>

  <div id="categories"></div>

  <div class="footer">
    © 2025 星野娜娜 私人歌单<br>
    点复制直接发直播间
  </div>
</div>

<script type="module">
import { getDoc, setDoc, doc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

const STORAGE_KEY = 'nanasing_progress_2025';
let progress = {}; // 本地缓存进度
let allSongs = [];

// 获取今天日期
function getTodayDate() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

// 从本地加载歌单
fetch('songs.json')
  .then(r => r.json())
  .then(songs => {
    allSongs = songs;
    // 先从 Firebase 载入进度
    loadAllProgress().then(() => {
      renderAll();
      updateCounter();
    });
  });

// 读取 Firebase 所有进度
async function loadAllProgress() {
  const db = window.firebaseDB;
  for (const song of allSongs) {
    try {
      const docRef = doc(db, 'progress', song.title);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        progress[song.title] = docSnap.data();
      }
    } catch(e) {
      console.error("Firebase读取失败:", e);
    }
  }
}

// 保存单首歌进度到 Firebase
async function saveProgress(title, data) {
  const db = window.firebaseDB;
  progress[title] = data;
  try {
    await setDoc(doc(db, 'progress', title), data);
  } catch(e) {
    console.error("Firebase保存失败:", e);
  }
}

// 分组按字数
function groupByLength(songs){
  const g = {};
  songs.forEach(i => { const l=i.title.length; g[l]=g[l]||[]; g[l].push(i); });
  return g;
}

// 渲染歌单
function renderAll() {
  const container = document.getElementById('categories');
  container.innerHTML = '';
  const groups = groupByLength(allSongs);
  const maxLen = Math.max(...Object.keys(groups).map(Number),1);

  for(let len=1; len<=maxLen; len++){
    if(!groups[len]) continue;

    const cat = document.createElement('div'); cat.className='category';
    const header = document.createElement('div'); header.className='cat-header';
    header.innerHTML = `<span>${len}字歌</span><span class="cat-count">(${groups[len].length})</span>`;
    const body = document.createElement('div'); body.className='cat-body';

    groups[len].forEach(song=>{
      const item = document.createElement('div'); item.className='song-item'; item.dataset.title=song.title;
      const data = progress[song.title];
      if(data?.date) item.style.background='rgba(100,255,180,0.15)';
      item.innerHTML = `
        <div class="song-info">
          <div class="title">${song.title}</div>
          ${song.artist ? `<div class="artist">${song.artist}</div>` : ''}
        </div>
        <button class="copy">复制</button>
      `;

      // 勾选框
      const checkbox = document.createElement('input'); checkbox.type='checkbox'; checkbox.style.transform='scale(1.4)'; checkbox.checked=!!(data?.date);
      checkbox.addEventListener('change',()=> {
        if(checkbox.checked){
          const today = getTodayDate();
          saveProgress(song.title, {...progress[song.title], date: today});
          item.style.background='rgba(100,255,180,0.15)';
        } else {
          saveProgress(song.title, {...progress[song.title], date: ''});
          item.style.background='';
        }
        updateCounter();
      });

      // 笔记
      const noteInput = document.createElement('input'); noteInput.type='text'; noteInput.placeholder='笔记…';
      if(data?.note) noteInput.value=data.note;
      noteInput.addEventListener('input',()=> {
        saveProgress(song.title, {...progress[song.title], note: noteInput.value});
      });

      const controlBar = document.createElement('div');
      controlBar.style.cssText='display:flex;align-items:center;gap:10px;min-width:180px;justify-content:flex-end;flex-shrink:0;';
      controlBar.appendChild(checkbox);
      controlBar.appendChild(noteInput);
      item.appendChild(controlBar);

      // 复制按钮
      item.querySelector('.copy').onclick=()=>{
        const txt = song.artist ? `${song.title} - ${song.artist}` : song.title;
        navigator.clipboard.writeText(txt);
        item.querySelector('.copy').textContent='✓';
        setTimeout(()=>item.querySelector('.copy').textContent='复制',1500);
      };

      body.appendChild(item);
    });

    header.onclick = ()=>{header.classList.toggle('open'); body.classList.toggle('open');};
    cat.appendChild(header); cat.appendChild(body); container.appendChild(cat);
  }
}

// 更新统计
function updateCounter(){
  const total = allSongs.length;
  const done = Object.keys(progress).filter(k=>progress[k]?.date).length;
  const pct = total===0?0:Math.round(done/total*100);
  const sub = document.querySelector('.subtitle');
  sub.innerText = `共${total}首 | 已点：${done}/${total}（${pct}%）`;
}

// 搜索
document.getElementById('searchInput').oninput=function(){
  const kw=this.value.trim().toLowerCase();
  document.querySelectorAll('.song-item').forEach(item=>{
    const t=item.dataset.title.toLowerCase();
    const a=(item.querySelector('.artist')?.innerText||'').toLowerCase();
    if(t.includes(kw)||a.includes(kw)){
      item.classList.add('highlight'); item.style.display=''; 
      item.closest('.cat-body').classList.add('open'); item.closest('.cat-body').previousElementSibling.classList.add('open');
    } else { item.classList.remove('highlight'); item.style.display=kw===''?'':'none'; }
  });
};

</script>
</body>
</html>
